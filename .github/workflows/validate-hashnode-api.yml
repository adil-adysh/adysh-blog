name: Validate Hashnode GraphQL Contract

on:
  workflow_dispatch:
  schedule:
    # Daily check â€” catches silent API changes
    - cron: "0 2 * * *"
  push:
    branches: [main]
    paths:
      - "validate-hashnode-series.ps1"
      - ".github/workflows/validate-hashnode-api.yml"

permissions:
  contents: read

concurrency:
  group: hashnode-contract-validation
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Hashnode API Contract
    runs-on: ubuntu-latest

    env:
      HASHNODE_KEY: ${{ secrets.HASHNODE_KEY }}

    steps:
      # ----------------------------------
      # Checkout
      # ----------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ----------------------------------
      # Preflight validation
      # ----------------------------------
      - name: Verify Hashnode API key exists
        shell: pwsh
        run: |
          if (-not $env:HASHNODE_KEY) {
            Write-Error "HASHNODE_KEY secret is missing"
            exit 1
          }
          Write-Host "âœ… HASHNODE_KEY found"

      # ----------------------------------
      # Fetch latest GraphQL schema
      # ----------------------------------
      - name: Fetch latest Hashnode GraphQL schema
        id: fetch-schema
        shell: pwsh
        run: |
          $headers = @{
            Authorization = "Bearer $env:HASHNODE_KEY"
            "Content-Type" = "application/json"
          }

          $query = @"
          query IntrospectionQuery {
            __schema {
              types {
                kind
                name
                description
                fields {
                  name
                  description
                  args {
                    name
                    description
                    type {
                      kind
                      name
                      ofType {
                        kind
                        name
                        ofType { kind name }
                      }
                    }
                  }
                }
                inputFields {
                  name
                  description
                  type {
                    kind
                    name
                    ofType { kind name ofType { kind name } }
                  }
                }
                enumValues { name }
              }
            }
          }
          "@

          $body = @{ query = $query } | ConvertTo-Json -Depth 10

          try {
            $response = Invoke-RestMethod `
              -Uri "https://gql.hashnode.com" `
              -Method POST `
              -Headers $headers `
              -Body $body `
              -TimeoutSec 30
          }
          catch {
            Write-Error "Failed to fetch GraphQL schema from Hashnode"
            throw
          }

          if (-not $response.data.__schema) {
            Write-Error "Invalid introspection response: __schema missing"
            exit 1
          }

          $response.data |
            ConvertTo-Json -Depth 25 |
            Out-File hashnode-schema.graphql -Encoding utf8

          Write-Host "âœ… Latest Hashnode schema fetched"

      # ----------------------------------
      # Validate API assumptions
      # ----------------------------------
      - name: Validate Hashnode API contract
        shell: pwsh
        run: |
          pwsh ./validate-hashnode-series.ps1 `
            -SchemaPath hashnode-schema.graphql `
            -PostsPath posts

      # ----------------------------------
      # Failure diagnostics
      # ----------------------------------
      - name: Upload schema artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hashnode-schema-on-failure
          path: hashnode-schema.graphql
          retention-days: 7

      # ----------------------------------
      # Success signal
      # ----------------------------------
      - name: Validation success
        if: success()
        run: |
          echo "ðŸŽ‰ Hashnode API contract validated successfully"
