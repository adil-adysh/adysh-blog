name: Validate Hashnode GraphQL Contract

on:
  workflow_dispatch:
  schedule:
    # Daily check â€” catches silent API changes
    - cron: "0 2 * * *"
  push:
    branches:
      - main
    paths:
      - "validate-hashnode-series.ps1"
      - ".github/workflows/validate-hashnode-api.yml"

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      HASHNODE_KEY: ${{ secrets.HASHNODE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # PowerShell (`pwsh`) is preinstalled on GitHub runners; no setup step required

      - name: Verify Hashnode API key exists
        shell: pwsh
        run: |
          if (-not $env:HASHNODE_KEY) {
            Write-Error "HASHNODE_KEY secret is missing"
          }
          Write-Host "âœ… HASHNODE_KEY found"

      # -------------------------------
      # Always fetch latest schema
      # -------------------------------
      - name: Fetch latest Hashnode GraphQL schema
        shell: pwsh
        run: |
          $headers = @{
            "Authorization" = "Bearer $env:HASHNODE_KEY"
            "Content-Type"  = "application/json"
          }

          $query = @"
          query IntrospectionQuery {
            __schema {
              types {
                kind
                name
                description
                # For object types
                fields {
                  name
                  description
                  args {
                    name
                    description
                    type {
                      kind
                      name
                      ofType {
                        kind
                        name
                        ofType { kind name }
                      }
                    }
                  }
                }
                # For input object types
                inputFields {
                  name
                  description
                  type { kind name ofType { kind name ofType { kind name } } }
                }
                enumValues { name }
              }
            }
          }
          "@

          $body = @{ query = $query } | ConvertTo-Json -Depth 10

          $response = Invoke-RestMethod `
            -Uri https://gql.hashnode.com `
            -Method POST `
            -Headers $headers `
            -Body $body

          # Overwrite schema every run (never trust committed copy)
          $response.data | ConvertTo-Json -Depth 25 `
            | Out-File hashnode-schema.graphql -Encoding utf8

          Write-Host "âœ… Latest Hashnode schema fetched"

      # -------------------------------
      # Validate assumptions
      # -------------------------------
      - name: Validate Hashnode API contract
        shell: pwsh
        run: |
          pwsh ./validate-hashnode-series.ps1 `
            -SchemaPath hashnode-schema.graphql `
            -PostsPath posts

      - name: Upload schema artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hashnode-schema-on-failure
          path: hashnode-schema.graphql
          retention-days: 7

      - name: Validation success
        if: success()
        run: echo "ðŸŽ‰ Hashnode API contract validated successfully"
